{% extends "base.html" %}
{% block content %}

<div class="page">
  <div class="hero hero--wide">
    <div class="panel panel--wide panel--inner">

      <div class="panel__top">
        <span class="panel__pill">Losowanie Bingo</span>
      </div>
      <div class="raffle-stage is-in">
        <div class="raffle-board">
          <div class="raffle-grid">
            {% for row in grid %}
              {% for cell in row %}
                <div class="raffle-tile">
                  <div class="raffle-text">
                    {% if cell %}{{ cell.text }}{% else %}â€”{% endif %}
                  </div>
                </div>
              {% endfor %}
            {% endfor %}
          </div>
        </div>
      </div>

      <div class="actions" style="margin-top: 16px;">
        <a class="btn btn--primary" href="{% url 'raffle' %}">Losuj ponownie</a>
      </div>

    </div>
  </div>
</div>

<script>
(function(){
  function getCookie(name) {
    const v = `; ${document.cookie}`;
    const parts = v.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }
  const csrftoken = getCookie('csrftoken');

  const tiles = document.querySelectorAll(".raffle-tile");
  tiles.forEach((tile, i) => tile.dataset.index = String(i));

  tiles.forEach(tile => {
    tile.addEventListener("click", async () => {
      if (tile.dataset.locked === "1") return;
      if (tile.dataset.busy === "1") return;

      tile.dataset.busy = "1";
      tile.classList.add("is-loading");

      const form = new FormData();
      form.append("index", tile.dataset.index);

      try {
        const res = await fetch("{% url 'raffle_reroll' %}", {
          method: "POST",
          headers: {"X-CSRFToken": csrftoken},
          body: form
        });
        const contentType = res.headers.get("content-type") || "";
        if (!contentType.includes("application/json")) {
          console.warn("Non-JSON response:", res.status);
          return;
        }

        const data = await res.json();
        if (!data.ok) {
          console.warn(data.error || "Reroll failed");
          return;
        }

        const textEl = tile.querySelector(".raffle-text");
        if (textEl) textEl.textContent = data.text;

        tile.dataset.locked = "1";
        tile.classList.add("is-locked");

      } catch(e) {
        console.error(e);
      } finally {
        tile.dataset.busy = "0";
        tile.classList.remove("is-loading");
      }
    });
  });
})();
</script>

{% endblock %}
