{% extends "base.html" %}
{% load static %}

{% block content %}

<audio id="rerollSound" src="{% static 'bingo/sfx/reroll.mp3' %}" preload="auto"></audio>

<div class="page">
  <div class="hero hero--wide">
    <div class="panel panel--wide panel--inner">

      <div class="panel__top">
        <span class="panel__pill">Losowanie Bingo</span>
        <form method="post" action="{% url 'logout' %}" class="logout-form">
          {% csrf_token %}
          <button type="submit" class="btn btn--danger">Wyloguj</button>
        </form>
      </div>

      <div class="raffle-shell">
        {% if grids|length > 1 %}
          <button class="raffle-nav raffle-nav--left" type="button" aria-label="Poprzedni grid">‹</button>
          <button class="raffle-nav raffle-nav--right" type="button" aria-label="Następny grid">›</button>
        {% endif %}

        <div class="raffle-stage">

          {# placeholder: overlay działa nawet gdy grids=[] (0 plansz na starcie) #}
          <div class="raffle-board raffle-board--set raffle-board--placeholder" data-grid="0">
            <div class="reroll-overlay" hidden>
              <img src="{% static 'bingo/images/cat-gambling.gif' %}" alt="cat reroll" />
            </div>
          </div>

          {% for grid in grids %}
            <div class="raffle-board raffle-board--set" data-grid="{{ forloop.counter0 }}">
              <div class="raffle-grid" style="--grid-size: {{ grid_size|default:5 }};">
                {% for row in grid %}
                  {% for cell in row %}
                    <div class="raffle-tile">
                      <div class="raffle-text">
                        {% if cell %}
                          <div class="cell-text">{{ cell.text }}</div>
                            {% if cell.assigned_user %}
                              <div class="cell-user">{{ cell.assigned_user }}</div>
                            {% endif %}
                            {% else %}
                              —
                            {% endif %}
                      </div>
                    </div>
                  {% endfor %}
                {% endfor %}
              </div>
            </div>
          {% endfor %}

        </div>
      </div>

      <div id="raffle-has-state" data-has="{{ has_state|yesno:'1,0' }}"></div>

      <div class="raffle-actions">
        <div class="btn-wrap">
          <button class="btn btn--primary" type="button" id="btnReroll">REROLL</button>
          <div class="btn-badge" id="badgeReroll">{{ rerolls_left|default_if_none:3 }}</div>
        </div>

        <div class="btn-wrap">
          <button class="btn btn--secondary" type="button" id="btnShuffle">SHUFFLE</button>
          <div class="btn-badge" id="badgeShuffle">{{ shuffles_left|default_if_none:3 }}</div>
        </div>

        <div class="btn-wrap">
          <button class="btn btn--secondary" type="button" id="btnPick">WYBIERAM CIEBIE</button>
          <div class="btn-badge btn-badge--disabled" id="badgePick">;3 UWU</div>
        </div>
      </div>

    </div>
  </div>
</div>

<script id="raffle-config" type="application/json">
  {
    "endpoints": {
      "shuffle": "{% url 'raffle_shuffle_use' %}",
      "reroll": "{% url 'raffle_reroll_all' %}",
      "unlock": "{% url 'raffle_unlock_next' %}",
      "init": "{% url 'raffle_init' %}",
      "pick": "{% url 'raffle_pick_save' %}"
    },
    "gridSize": {{ grid_size|default:5 }},
    "audio": { "rerollId": "rerollSound" }
  }
</script>

{% endblock %}

{% block scripts %}

  {# jeśli raffle.js korzysta z window.Bingo.getCookie/showToast, runtime musi być pierwszy #}
  <script defer src="{% static 'bingo/js/plugin_runtime.js' %}"></script>
  <script defer src="{% static 'bingo/js/raffle.js' %}"></script>
{% endblock %}
