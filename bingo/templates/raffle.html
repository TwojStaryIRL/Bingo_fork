{% extends "base.html" %}
{% load static %}
{% block content %}

<audio id="rerollSound" src="{% static 'bingo/sfx/reroll.mp3' %}" preload="auto"></audio>

<div class="page">
  <div class="hero hero--wide">
    <div class="panel panel--wide panel--inner">

      <div class="panel__top">
        <span class="panel__pill">Losowanie Bingo</span>
      </div>

      <div class="raffle-shell">
        <button class="raffle-nav raffle-nav--left" type="button" aria-label="Poprzedni grid">‹</button>
        <button class="raffle-nav raffle-nav--right" type="button" aria-label="Następny grid">›</button>

        <div class="raffle-stage">
          {% for grid in grids %}
            <div class="raffle-board raffle-board--set" data-grid="{{ forloop.counter0 }}">
              <div class="raffle-grid">
                {% for row in grid %}
                  {% for cell in row %}
                    <div class="raffle-tile">
                      <div class="raffle-text">
                        {% if cell %}{{ cell.text }}{% else %}—{% endif %}
                      </div>
                    </div>
                  {% endfor %}
                {% endfor %}
              </div>
            </div>
          {% endfor %}
        </div>
      </div>

      <div class="raffle-actions">
        <div class="btn-wrap">
          <button class="btn btn--primary" type="button" id="btnReroll">REROLL</button>
          <div class="btn-badge" id="badgeReroll">3</div>
        </div>

        <div class="btn-wrap">
          <button class="btn btn--secondary" type="button" id="btnShuffle">SHUFFLE</button>
          <div class="btn-badge" id="badgeShuffle">3</div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
(function(){
  function getCookie(name) {
    const v = `; ${document.cookie}`;
    const parts = v.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }
  const csrftoken = getCookie('csrftoken');

  const boards = Array.from(document.querySelectorAll(".raffle-board--set"));
  const left = document.querySelector(".raffle-nav--left");
  const right = document.querySelector(".raffle-nav--right");

  const btnReroll = document.getElementById("btnReroll");
  const btnShuffle = document.getElementById("btnShuffle");

  const badgeReroll = document.getElementById("badgeReroll");
  const badgeShuffle = document.getElementById("badgeShuffle");

  const audio = document.getElementById("rerollSound");

  let active = 0;
  let rerollsUsed = 0;   // max 3
  let shufflesUsed = 0;  // max 3

  function applyClasses() {
    if (!boards.length) return;
    boards.forEach((b, i) => {
      b.classList.remove("raffle-board--active","raffle-board--prev","raffle-board--next","raffle-board--hidden");
      if (i === active) b.classList.add("raffle-board--active");
      else if (i === (active + boards.length - 1) % boards.length) b.classList.add("raffle-board--prev");
      else if (i === (active + 1) % boards.length) b.classList.add("raffle-board--next");
      else b.classList.add("raffle-board--hidden");
    });
  }

  function updateBadges() {
    const rerollLeft = Math.max(0, 3 - rerollsUsed);
    const shuffleLeft = Math.max(0, 3 - shufflesUsed);

    badgeReroll.textContent = String(rerollLeft);
    badgeShuffle.textContent = String(shuffleLeft);

    badgeReroll.classList.toggle("btn-badge--disabled", rerollLeft === 0);
    badgeShuffle.classList.toggle("btn-badge--disabled", shuffleLeft === 0);

    btnReroll.disabled = (rerollLeft === 0);
    btnShuffle.disabled = (shuffleLeft === 0);
  }

  function show(n){
    if (!boards.length) return;
    active = (n + boards.length) % boards.length;
    applyClasses();
  }

  if (left) left.addEventListener("click", () => show(active - 1));
  if (right) right.addEventListener("click", () => show(active + 1));

  // INIT
  applyClasses();
  updateBadges();

  // SHUFFLE (limit 3 na backendzie)
  if (btnShuffle) {
    btnShuffle.addEventListener("click", async () => {
      if (btnShuffle.disabled) return;

      try {
        const res = await fetch("{% url 'raffle_shuffle_use' %}", {
          method: "POST",
          headers: {"X-CSRFToken": csrftoken},
        });
        const data = await res.json();
        if (!data.ok) return;

        shufflesUsed = data.shuffles_used;

        const board = boards[active];
        const tiles = Array.from(board.querySelectorAll(".raffle-text"));
        const texts = tiles.map(t => t.textContent);

        for (let i = texts.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [texts[i], texts[j]] = [texts[j], texts[i]];
        }
        tiles.forEach((t, i) => t.textContent = texts[i]);

      } catch (e) {
        console.error(e);
      } finally {
        updateBadges();
      }
    });
  }

  // REROLL całego grida (limit 3 globalnie)
  if (btnReroll) {
    btnReroll.addEventListener("click", async () => {
      if (btnReroll.disabled) return;

      // dźwięk od początku
      if (audio) { audio.currentTime = 0; audio.play().catch(()=>{}); }

      const form = new FormData();
      form.append("grid", String(active));

      // łapiemy elementy przed try (żeby finally nie wywalił scope)
      const board = boards[active];
      const gridEl = board ? board.querySelector(".raffle-grid") : null;

      // start animacji
      if (gridEl) gridEl.classList.add("is-rerolling");

      // blokada spam-click
      btnReroll.disabled = true;

      try {
        const res = await fetch("{% url 'raffle_reroll_all' %}", {
          method: "POST",
          headers: {"X-CSRFToken": csrftoken},
          body: form
        });

        const data = await res.json();
        if (!data.ok) return;

        const tiles = Array.from(board.querySelectorAll(".raffle-text"));
        data.cells.forEach((txt, i) => {
          if (tiles[i]) tiles[i].textContent = txt;
        });

        rerollsUsed = (typeof data.rerolls_used === "number") ? data.rerolls_used : rerollsUsed;

      } catch (e) {
        console.error(e);
      } finally {
        // stop animacji
        setTimeout(() => { if (gridEl) gridEl.classList.remove("is-rerolling"); }, 260);
        updateBadges();
      }
    });
  }

})();
</script>

{% endblock %}
