{% extends "base.html" %}

{% block content %}
<div class="page">
  <div class="hero hero--wide">
    <div class="panel panel--wide">
      <div class="panel__top">
        <p class="panel__title"></p>
        <span class="panel__pill"></span>
      </div>
<div class="panel__top" style="justify-content:center; margin-bottom: 10px;">
  <span class="panel__pill">
    Zalogowany jako: {{ request.user.username }}
  </span>
</div>

      <form>
        <table class="grid-table">
          {% for r in rows %}
          <tr>
            {% for c in cols %}
            <td>
              <textarea
                class="grid-cell"
                data-cell="cell_{{ r }}_{{ c }}"
                rows="4"
                placeholder="Wpisz zdanie..."
              ></textarea>

              <!-- dropdown POD KAŻDYM POLEM -->
              <select
                class="user-select cell-user"
                data-cell="cell_{{ r }}_{{ c }}"
              >
                <option value="" selected>Przypisz użytkownika…</option>
                <option value="test">test</option>
                <option value="test2">test2</option>
                <option value="bigman">bigman</option>
                <option value="twojstary">twojstary</option>
              </select>
            </td>
            {% endfor %}
          </tr>
          {% endfor %}
        </table>

        <div class="actions" style="margin-top: 14px;">
          <button class="btn btn--primary" type="button" id="save-btn">Zapisz</button>
        </div>

        <p class="fineprint">Każdy użytkownik może być przypisany tylko do jednego pola.</p>
      </form>
    </div>
  </div>
</div>

<script>
  const selects = document.querySelectorAll(".cell-user");

  // mapowanie: user -> cell_id
  const assigned = {};

  selects.forEach(select => {
    select.addEventListener("change", () => {
      const cellId = select.dataset.cell;
      const user = select.value;

      if (!user) return;

      // jeśli user był przypisany gdzie indziej → cofamy poprzedni wybór
      if (assigned[user] && assigned[user] !== cellId) {
        const prevSelect = document.querySelector(
          `.cell-user[data-cell="${assigned[user]}"]`
        );
        if (prevSelect) prevSelect.value = "";
      }

      assigned[user] = cellId;

      // zablokuj usera w innych selectach
      selects.forEach(s => {
        if (s !== select) {
          const opt = s.querySelector(`option[value="${CSS.escape(user)}"]`);
          if (opt) opt.disabled = true;
        }
      });
    });
  });

  // (opcjonalnie) testowy zapis
  document.getElementById("save-btn").addEventListener("click", () => {
    alert("Zapis (na razie testowy) ✅");
  });
</script>
{% endblock %}
